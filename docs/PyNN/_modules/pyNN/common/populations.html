<!DOCTYPE html>
<html lang="en"
      data-content_root="../../../"
      x-data="{ darkMode: localStorage.getItem('darkMode') || localStorage.setItem('darkMode', 'system'), activeSection: '' }"
      x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))"
      class="scroll-smooth"
      :class="{'dark': darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)}"
>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="white" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="black" />
  
    <title>pyNN.common.populations | PyNN 0.12.3 documentation</title>
    <meta property="og:title" content="pyNN.common.populations | PyNN 0.12.3 documentation" />
    <meta name="twitter:title" content="pyNN.common.populations | PyNN 0.12.3 documentation" />
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/theme.css?v=42baaae4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=14d0ad6c" />
      <link rel="icon" href="../../../_static/pyNN_icon.ico" />
        <link rel="search" title="Search" href="../../../search.html" />
        <link rel="index" title="Index" href="../../../genindex.html" />

    <script>
    <!-- Prevent Flash of wrong theme -->
      const userPreference = localStorage.getItem('darkMode');
      let mode;
      if (userPreference === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
        mode = 'dark';
        document.documentElement.classList.add('dark');
      } else {
        mode = 'light';
      }
      if (!userPreference) {localStorage.setItem('darkMode', mode)}
    </script>
</head>
  <body x-data="{ showSidebar: false, showScrollTop: false }" class="min-h-screen font-sans antialiased bg-background text-foreground" :class="{ 'overflow-hidden': showSidebar }">
    <div x-cloak x-show="showSidebar" class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm md:hidden" @click.self="showSidebar = false"></div><div id="page" class="relative flex flex-col min-h-screen"><a href="#content" class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100">
      Skip to content
    </a><header
  class="sticky top-0 z-40 w-full border-b shadow-sm border-border supports-backdrop-blur:bg-background/60 bg-background/95 backdrop-blur"><div class="container flex items-center h-14">
    <div class="hidden mr-4 md:flex">
      <a href="../../../index.html" class="flex items-center mr-6">
          <img height="24" width="24" class="mr-2 dark:invert" src="../../../_static/pyNN_logo.png" alt="Logo" /><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">PyNN 0.12.3 documentation</span>
      </a></div><button
      class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden"
      type="button" @click="showSidebar = true">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" aria-hidden="true"
        fill="currentColor">
        <path
          d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z" />
      </svg>
      <span class="sr-only">Toggle navigation menu</span>
    </button>
    <div class="flex items-center justify-between flex-1 space-x-2 sm:space-x-4 md:justify-end">
      <div class="flex-1 w-full md:w-auto md:flex-none"><form id="searchbox"
      action="../../../search.html"
      method="get"
      class="relative flex items-center group"
      @keydown.k.window.meta="$refs.search.focus()">
  <input x-ref="search"
          name="q"
          id="search-input"
          type="search"
          aria-label="Search the docs"
          placeholder="Search ..."
          class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" />
  <kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
    <span class="text-xs">âŒ˜</span>
    K
  </kbd>
</form>
      </div>
      <nav class="flex items-center space-x-1">
        <button @click="darkMode = darkMode === 'light' ? 'dark' : 'light'"
          class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9"
          type="button"
          aria-label="Color theme switcher">
          <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0">
            <path
              d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100">
            <path
              d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z" />
          </svg>
        </button>
      </nav>
    </div>
  </div>
</header>

    <div class="flex-1"><div class="container flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside id="left-sidebar"
  class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full shrink-0 overflow-y-auto border-r border-border md:sticky"
  :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }">

    <a href="../../../index.html" class="!justify-start text-sm md:!hidden bg-background">
        <img height="16" width="16" class="mr-2 dark:invert" src="../../../_static/pyNN_logo.png" alt="Logo" /><span class="font-bold text-clip whitespace-nowrap">PyNN 0.12.3 documentation</span>
    </a>

    <div class="relative overflow-hidden md:overflow-auto my-4 md:my-0 h-[calc(100vh-8rem)] md:h-auto">
      <div class="overflow-y-auto h-full w-full relative pr-6"><nav class="table w-full min-w-full my-6 lg:my-8">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_networks.html">Building networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../injecting_current.html">Injecting current</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recording.html">Recording spikes and state variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_handling.html">Data handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../simulation_control.html">Simulation control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parameters.html">Model parameters and initial values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random_numbers.html">Random numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mc_api.html">Multicompartmental modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parallel.html">Running parallel simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../import_export.html">Importing from and exporting to other formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications about, relating to or using PyNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors, licence and funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developers_guide.html">Developersâ€™ guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../developers/bug_reports.html">Bug reports and feature requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developers/contributing.html">Contributing to PyNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developers/governance.html">Governance</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference.html">API reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/populations.html">Populations, Views and Assemblies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/connectors.html">Connectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/projections.html">Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/neuronmodels.html">Neuron models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/plasticitymodels.html">Synapse models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/electrodes.html">Current sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/simulationcontrol.html">Simulation control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/random.html">Random numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/parameters.html">Parameter handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/space.html">Spatial structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/utility.html">Utility classes and functions</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../standardmodels.html">Standard models</a></li>
</ul>

</nav>
      </div>
    </div>
    <button type="button" @click="showSidebar = false"
      class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
        stroke="none" class="h-4 w-4">
        <path
          d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z" />
      </svg>
    </button>
  </aside>
        <main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs"
     class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
  <a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground"
     href="../../../index.html">
    <span class="hidden md:inline">PyNN 0.12.3 documentation</span>
    <svg xmlns="http://www.w3.org/2000/svg"
         height="18"
         width="18"
         viewBox="0 96 960 960"
         aria-label="Home"
         fill="currentColor"
         stroke="none"
         class="md:hidden">
      <path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z" />
    </svg>
  </a>
  
<div class="mr-1">/</div><a class="hover:text-foreground overflow-hidden text-ellipsis whitespace-nowrap"
       href="../../index.html">Module code</a>
    
<div class="mr-1">/</div><span aria-current="page"
        class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">pyNN.common.populations</span>
</nav>

    <div id="content" role="main">
      <h1>Source code for pyNN.common.populations</h1><div class="highlight"><pre>
<span></span><code><span id="line-1"><span class="c1"># encoding: utf-8</span>
</span><span id="line-2"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-3"><span class="sd">Common implementation of ID, Population, PopulationView and Assembly classes.</span>
</span><span id="line-4">
</span><span id="line-5"><span class="sd">These base classes should be sub-classed by the backend-specific classes.</span>
</span><span id="line-6">
</span><span id="line-7"><span class="sd">:copyright: Copyright 2006-2024 by the PyNN team, see AUTHORS.</span>
</span><span id="line-8"><span class="sd">:license: CeCILL, see LICENSE for details.</span>
</span><span id="line-9"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-10">
</span><span id="line-11"><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="line-12"><span class="kn">import</span> <span class="nn">operator</span>
</span><span id="line-13"><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="line-14"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
</span><span id="line-15"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
</span><span id="line-16"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span><span id="line-17"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="line-18"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">recording</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">standardmodels</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">descriptions</span>
</span><span id="line-19"><span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">BaseCellType</span>
</span><span id="line-20"><span class="kn">from</span> <span class="nn">..parameters</span> <span class="kn">import</span> <span class="n">ParameterSpace</span><span class="p">,</span> <span class="n">LazyArray</span><span class="p">,</span> <span class="n">simplify</span> <span class="k">as</span> <span class="n">simplify_parameter_array</span>
</span><span id="line-21"><span class="kn">from</span> <span class="nn">..recording</span> <span class="kn">import</span> <span class="n">files</span>
</span><span id="line-22">
</span><span id="line-23">
</span><span id="line-24"><span class="n">deprecated</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">deprecated</span>
</span><span id="line-25"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;PyNN&quot;</span><span class="p">)</span>
</span><span id="line-26">
</span><span id="line-27">
</span><span id="line-28"><span class="k">def</span> <span class="nf">is_conductance</span><span class="p">(</span><span class="n">target_cell</span><span class="p">):</span>
</span><span id="line-29"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-30"><span class="sd">    Returns True if the target cell uses conductance-based synapses, False if</span>
</span><span id="line-31"><span class="sd">    it uses current-based synapses, and None if the synapse-basis cannot be</span>
</span><span id="line-32"><span class="sd">    determined.</span>
</span><span id="line-33"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-34">    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target_cell</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">target_cell</span><span class="o">.</span><span class="n">local</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target_cell</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">):</span>
</span><span id="line-35">        <span class="n">is_conductance</span> <span class="o">=</span> <span class="n">target_cell</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">conductance_based</span>
</span><span id="line-36">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-37">        <span class="n">is_conductance</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-38">    <span class="k">return</span> <span class="n">is_conductance</span>
</span><span id="line-39">
</span><span id="line-40">
</span><span id="line-41"><span class="k">class</span> <span class="nc">IDMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="line-42"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-43"><span class="sd">    Instead of storing ids as integers, we store them as ID objects,</span>
</span><span id="line-44"><span class="sd">    which allows a syntax like:</span>
</span><span id="line-45"><span class="sd">        p[3,4].tau_m = 20.0</span>
</span><span id="line-46"><span class="sd">    where p is a Population object.</span>
</span><span id="line-47"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-48">    <span class="c1"># Simulator ID classes should inherit both from the base type of the ID</span>
</span><span id="line-49">    <span class="c1"># (e.g., int or long) and from IDMixin.</span>
</span><span id="line-50">
</span><span id="line-51">    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="line-52">        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;parent&quot;</span><span class="p">:</span>
</span><span id="line-53">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;parent is not set&quot;</span><span class="p">)</span>
</span><span id="line-54">        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
</span><span id="line-55">            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;For individual cells, set values using the parameter name directly, &quot;</span> \
</span><span id="line-56">                     <span class="s2">&quot;e.g. population[0].tau_m = 20.0, or use &#39;set&#39; on a population view, &quot;</span> \
</span><span id="line-57">                     <span class="s2">&quot;e.g. population[0:1].set(tau_m=20.0)&quot;</span>
</span><span id="line-58">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="line-59">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-60">            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
</span><span id="line-61">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="line-62">            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">NonExistentParameterError</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-63">                                                   <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="line-64">                                                   <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">())</span>
</span><span id="line-65">        <span class="k">return</span> <span class="n">val</span>
</span><span id="line-66">
</span><span id="line-67">    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-68">        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;parent&quot;</span><span class="p">:</span>
</span><span id="line-69">            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-70">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span id="line-71">            <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
</span><span id="line-72">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-73">            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-74">
</span><span id="line-75">    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
</span><span id="line-76"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-77"><span class="sd">        Set cell parameters, given as a sequence of parameter=value arguments.</span>
</span><span id="line-78"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-79">        <span class="c1"># if some of the parameters are computed from the values of other</span>
</span><span id="line-80">        <span class="c1"># parameters, need to get and translate all parameters</span>
</span><span id="line-81">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">:</span>
</span><span id="line-82">            <span class="bp">self</span><span class="o">.</span><span class="n">as_view</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="line-83">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-84">            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">NotLocalError</span><span class="p">(</span>
</span><span id="line-85">                <span class="s2">&quot;Cannot set parameters for a cell that does not exist on this node.&quot;</span><span class="p">)</span>
</span><span id="line-86">
</span><span id="line-87">    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-88"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of all cell parameters.&quot;&quot;&quot;</span>
</span><span id="line-89">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">:</span>
</span><span id="line-90">            <span class="n">parameter_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">()</span>
</span><span id="line-91">            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="line-92">                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_view</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">)))</span>
</span><span id="line-93">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-94">            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">NotLocalError</span><span class="p">(</span>
</span><span id="line-95">                <span class="s2">&quot;Cannot obtain parameters for a cell that does not exist on this node.&quot;</span><span class="p">)</span>
</span><span id="line-96">
</span><span id="line-97">    <span class="nd">@property</span>
</span><span id="line-98">    <span class="k">def</span> <span class="nf">celltype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-99">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">celltype</span>
</span><span id="line-100">
</span><span id="line-101">    <span class="nd">@property</span>
</span><span id="line-102">    <span class="k">def</span> <span class="nf">is_standard_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-103">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span> <span class="n">standardmodels</span><span class="o">.</span><span class="n">StandardCellType</span><span class="p">)</span>
</span><span id="line-104">
</span><span id="line-105">    <span class="k">def</span> <span class="nf">_set_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
</span><span id="line-106"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-107"><span class="sd">        Set the cell position in 3D space.</span>
</span><span id="line-108">
</span><span id="line-109"><span class="sd">        Cell positions are stored in an array in the parent Population.</span>
</span><span id="line-110"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-111">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
</span><span id="line-112">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</span><span id="line-113">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_set_cell_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
</span><span id="line-114">
</span><span id="line-115">    <span class="k">def</span> <span class="nf">_get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-116"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-117"><span class="sd">        Return the cell position in 3D space.</span>
</span><span id="line-118">
</span><span id="line-119"><span class="sd">        Cell positions are stored in an array in the parent Population, if any,</span>
</span><span id="line-120"><span class="sd">        or within the ID object otherwise. Positions are generated the first</span>
</span><span id="line-121"><span class="sd">        time they are requested and then cached.</span>
</span><span id="line-122"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-123">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_get_cell_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="line-124">
</span><span id="line-125">    <span class="n">position</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_position</span><span class="p">,</span> <span class="n">_set_position</span><span class="p">)</span>
</span><span id="line-126">
</span><span id="line-127">    <span class="nd">@property</span>
</span><span id="line-128">    <span class="k">def</span> <span class="nf">local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-129">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_local</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="line-130">
</span><span id="line-131">    <span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_source</span><span class="p">):</span>
</span><span id="line-132"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject current from a current source object into the cell.&quot;&quot;&quot;</span>
</span><span id="line-133">        <span class="n">current_source</span><span class="o">.</span><span class="n">inject_into</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>
</span><span id="line-134">
</span><span id="line-135">    <span class="k">def</span> <span class="nf">get_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
</span><span id="line-136"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the initial value of a state variable of the cell.&quot;&quot;&quot;</span>
</span><span id="line-137">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_get_cell_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
</span><span id="line-138">
</span><span id="line-139">    <span class="k">def</span> <span class="nf">set_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-140"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the initial value of a state variable of the cell.&quot;&quot;&quot;</span>
</span><span id="line-141">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_set_cell_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-142">
</span><span id="line-143">    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-144"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a PopulationView containing just this cell.&quot;&quot;&quot;</span>
</span><span id="line-145">        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="line-146">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="line-147">
</span><span id="line-148">
</span><span id="line-149"><span class="k">class</span> <span class="nc">BasePopulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="line-150">    <span class="n">_record_filter</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-151">
</span><span id="line-152">    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="line-153"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-154"><span class="sd">        Return either a single cell (ID object) from the Population, if `index`</span>
</span><span id="line-155"><span class="sd">        is an integer, or a subset of the cells (PopulationView object), if</span>
</span><span id="line-156"><span class="sd">        `index` is a slice or array.</span>
</span><span id="line-157">
</span><span id="line-158"><span class="sd">        Note that __getitem__ is called when using [] access, e.g.</span>
</span><span id="line-159"><span class="sd">            p = Population(...)</span>
</span><span id="line-160"><span class="sd">            p[2] is equivalent to p.__getitem__(2).</span>
</span><span id="line-161"><span class="sd">            p[3:6] is equivalent to p.__getitem__(slice(3, 6))</span>
</span><span id="line-162"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-163">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
</span><span id="line-164">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="line-165">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
</span><span id="line-166">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span id="line-167">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="line-168">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="line-169">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-170">            <span class="n">index_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="line-171">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-172">                <span class="sa">f</span><span class="s2">&quot;indices must be integers, slices, lists, arrays or tuples, not </span><span class="si">{</span><span class="n">index_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-173">
</span><span id="line-174">    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-175"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the total number of cells in the population (all nodes).&quot;&quot;&quot;</span>
</span><span id="line-176">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span><span id="line-177">
</span><span id="line-178">    <span class="nd">@property</span>
</span><span id="line-179">    <span class="k">def</span> <span class="nf">local_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-180"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of cells in the population on the local MPI node&quot;&quot;&quot;</span>
</span><span id="line-181">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span><span class="p">)</span>  <span class="c1"># would self._mask_local.sum() be faster?</span>
</span><span id="line-182">
</span><span id="line-183">    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-184"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterator over cell ids on the local node.&quot;&quot;&quot;</span>
</span><span id="line-185">        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span><span class="p">)</span>
</span><span id="line-186">
</span><span id="line-187">    <span class="nd">@property</span>
</span><span id="line-188">    <span class="k">def</span> <span class="nf">conductance_based</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-189"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-190"><span class="sd">        Indicates whether the post-synaptic response is modelled as a change</span>
</span><span id="line-191"><span class="sd">        in conductance or a change in current.</span>
</span><span id="line-192"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-193">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">conductance_based</span>
</span><span id="line-194">
</span><span id="line-195">    <span class="nd">@property</span>
</span><span id="line-196">    <span class="k">def</span> <span class="nf">receptor_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-197">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">receptor_types</span>
</span><span id="line-198">
</span><span id="line-199">    <span class="k">def</span> <span class="nf">is_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="line-200"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-201"><span class="sd">        Indicates whether the cell with the given ID exists on the local MPI node.</span>
</span><span id="line-202"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-203">        <span class="k">assert</span> <span class="nb">id</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">self</span>
</span><span id="line-204">        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="line-205">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="line-206">
</span><span id="line-207">    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-208"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterator over cell ids on all MPI nodes.&quot;&quot;&quot;</span>
</span><span id="line-209">        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-210">
</span><span id="line-211">    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="line-212"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-213"><span class="sd">        A Population/PopulationView can be added to another Population,</span>
</span><span id="line-214"><span class="sd">        PopulationView or Assembly, returning an Assembly.</span>
</span><span id="line-215"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-216">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BasePopulation</span><span class="p">)</span>
</span><span id="line-217">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assembly_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span id="line-218">
</span><span id="line-219">    <span class="k">def</span> <span class="nf">_get_cell_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="line-220">        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="line-221">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span>
</span><span id="line-222">
</span><span id="line-223">    <span class="k">def</span> <span class="nf">_set_cell_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
</span><span id="line-224">        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="line-225">        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
</span><span id="line-226">
</span><span id="line-227">    <span class="nd">@property</span>
</span><span id="line-228">    <span class="k">def</span> <span class="nf">position_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># &quot;generator&quot; is a misleading name, has no yield statement</span>
</span><span id="line-229">        <span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="line-230">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="line-231">        <span class="k">return</span> <span class="n">gen</span>
</span><span id="line-232">
</span><span id="line-233">    <span class="k">def</span> <span class="nf">_get_cell_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
</span><span id="line-234">        <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">:</span>
</span><span id="line-235">            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">LazyArray</span><span class="p">)</span>
</span><span id="line-236">            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_local_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="line-237">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
</span><span id="line-238">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-239">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="line-240">                <span class="s2">&quot;Variable &#39;</span><span class="si">{}</span><span class="s2">&#39; is not in initial values, returning 0.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
</span><span id="line-241">            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="line-242">
</span><span id="line-243">    <span class="k">def</span> <span class="nf">_set_cell_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-244">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="n">LazyArray</span><span class="p">)</span>
</span><span id="line-245">        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_local_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="line-246">        <span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="line-247">
</span><span id="line-248">    <span class="k">def</span> <span class="nf">nearest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
</span><span id="line-249"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the neuron closest to the specified position.&quot;&quot;&quot;</span>
</span><span id="line-250">        <span class="c1"># doesn&#39;t always work correctly if a position is equidistant between</span>
</span><span id="line-251">        <span class="c1"># two neurons, i.e. 0.5 should be rounded up, but it isn&#39;t always.</span>
</span><span id="line-252">        <span class="c1"># also doesn&#39;t take account of periodic boundary conditions</span>
</span><span id="line-253">        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">position</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</span><span id="line-254">        <span class="n">dist_arr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span><span id="line-255">        <span class="n">distances</span> <span class="o">=</span> <span class="n">dist_arr</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-256">        <span class="n">nearest</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
</span><span id="line-257">        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span>
</span><span id="line-258">
</span><span id="line-259">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-260"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-261"><span class="sd">        Randomly sample `n` cells from the Population, and return a</span>
</span><span id="line-262"><span class="sd">        PopulationView object.</span>
</span><span id="line-263"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-264">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</span><span id="line-265">        <span class="k">if</span> <span class="ow">not</span> <span class="n">rng</span><span class="p">:</span>
</span><span id="line-266">            <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">NumpyRNG</span><span class="p">()</span>
</span><span id="line-267">        <span class="n">indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
</span><span id="line-268">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The </span><span class="si">%d</span><span class="s2"> cells selected have indices </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
</span><span id="line-269">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.sample(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="line-270">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="line-271">
</span><span id="line-272">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_names</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-273"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-274"><span class="sd">        Get the values of the given parameters for every local cell in the</span>
</span><span id="line-275"><span class="sd">        population, or, if gather=True, for all cells in the population.</span>
</span><span id="line-276">
</span><span id="line-277"><span class="sd">        Values will be expressed in the standard PyNN units (i.e. millivolts,</span>
</span><span id="line-278"><span class="sd">        nanoamps, milliseconds, microsiemens, nanofarads, event per second).</span>
</span><span id="line-279"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-280">        <span class="c1"># if all the cells have the same value for a parameter, should</span>
</span><span id="line-281">        <span class="c1"># we return just the number, rather than an array?</span>
</span><span id="line-282">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-283">            <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameter_names</span><span class="p">,)</span>
</span><span id="line-284">            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-285">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-286">            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-287">        <span class="n">parameter_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">(</span><span class="o">*</span><span class="n">parameter_names</span><span class="p">)</span>
</span><span id="line-288">        <span class="n">parameter_space</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_size</span><span class="p">,)</span>
</span><span id="line-289">
</span><span id="line-290">        <span class="c1"># re: simplify - what if parameter space is homogeneous on some nodes but not on others?</span>
</span><span id="line-291">        <span class="c1"># this also causes problems if the population size matches the number of MPI nodes</span>
</span><span id="line-292">        <span class="n">parameter_space</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">simplify</span><span class="o">=</span><span class="n">simplify</span><span class="p">)</span>
</span><span id="line-293">        <span class="n">parameter_space</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="line-294">        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameter_space</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</span><span id="line-295">
</span><span id="line-296">        <span class="k">if</span> <span class="n">gather</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-297">            <span class="c1"># seems inefficient to do it in a loop - should do as single operation</span>
</span><span id="line-298">            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">:</span>
</span><span id="line-299">                <span class="n">values</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="line-300">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="line-301">                    <span class="n">all_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span><span class="p">:</span> <span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
</span><span id="line-302">                    <span class="n">local_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="line-303">                    <span class="n">all_indices</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span><span class="p">:</span> <span class="n">local_indices</span><span class="p">}</span>
</span><span id="line-304">                    <span class="n">all_values</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">gather_dict</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span>
</span><span id="line-305">                    <span class="n">all_indices</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">gather_dict</span><span class="p">(</span><span class="n">all_indices</span><span class="p">)</span>
</span><span id="line-306">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-307">                        <span class="n">values</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">all_values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="line-308">                        <span class="n">indices</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">all_indices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="line-309">                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="line-310">                        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="line-311">                <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
</span><span id="line-312">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-313">            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">]</span>
</span><span id="line-314">        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="line-315">            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">NonExistentParameterError</span><span class="p">(</span>
</span><span id="line-316">                <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">())</span>
</span><span id="line-317">        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="line-318">            <span class="k">return</span> <span class="n">values</span>
</span><span id="line-319">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-320">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="line-321">            <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-322">
</span><span id="line-323">    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
</span><span id="line-324"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-325"><span class="sd">        Set one or more parameters for every cell in the population.</span>
</span><span id="line-326">
</span><span id="line-327"><span class="sd">        Values passed to set() may be:</span>
</span><span id="line-328"><span class="sd">            (1) single values</span>
</span><span id="line-329"><span class="sd">            (2) RandomDistribution objects</span>
</span><span id="line-330"><span class="sd">            (3) lists/arrays of values of the same size as the population</span>
</span><span id="line-331"><span class="sd">            (4) mapping functions, where a mapping function accepts a single</span>
</span><span id="line-332"><span class="sd">                argument (the cell index) and returns a single value.</span>
</span><span id="line-333">
</span><span id="line-334"><span class="sd">        Here, a &quot;single value&quot; may be either a single number or a list/array of</span>
</span><span id="line-335"><span class="sd">        numbers (e.g. for spike times). Values should be expressed in the</span>
</span><span id="line-336"><span class="sd">        standard PyNN units (i.e. millivolts, nanoamps, milliseconds,</span>
</span><span id="line-337"><span class="sd">        microsiemens, nanofarads, event per second).</span>
</span><span id="line-338">
</span><span id="line-339"><span class="sd">        Examples::</span>
</span><span id="line-340">
</span><span id="line-341"><span class="sd">            p.set(tau_m=20.0, v_rest=-65).</span>
</span><span id="line-342"><span class="sd">            p.set(spike_times=[0.3, 0.7, 0.9, 1.4])</span>
</span><span id="line-343"><span class="sd">            p.set(cm=rand_distr, tau_m=lambda i: 10 + i/10.0)</span>
</span><span id="line-344"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-345">        <span class="c1"># TODO: add example using of function of (x,y,z) and Population.position_generator</span>
</span><span id="line-346">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-347">            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span> <span class="n">standardmodels</span><span class="o">.</span><span class="n">StandardCellType</span><span class="p">)</span>
</span><span id="line-348">                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">computed_parameters_include</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="line-349">                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span> <span class="n">standardmodels</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">SpikeSourceArray</span><span class="p">)):</span>
</span><span id="line-350">                <span class="c1"># the last condition above is a bit of hack to avoid calling expand() unecessarily</span>
</span><span id="line-351">                <span class="c1"># need to get existing parameter space of models so we can perform calculations</span>
</span><span id="line-352">                <span class="n">native_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">get_native_names</span><span class="p">()</span>
</span><span id="line-353">                <span class="n">parameter_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">reverse_translate</span><span class="p">(</span>
</span><span id="line-354">                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_native_parameters</span><span class="p">(</span><span class="o">*</span><span class="n">native_names</span><span class="p">))</span>
</span><span id="line-355">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
</span><span id="line-356">                    <span class="n">parameter_space</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">)</span>
</span><span id="line-357">                <span class="n">parameter_space</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="line-358">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-359">                <span class="n">parameter_space</span> <span class="o">=</span> <span class="n">ParameterSpace</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span>
</span><span id="line-360">                                                 <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(),</span>
</span><span id="line-361">                                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span>
</span><span id="line-362">                                                 <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
</span><span id="line-363">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span> <span class="n">standardmodels</span><span class="o">.</span><span class="n">StandardCellType</span><span class="p">):</span>
</span><span id="line-364">                <span class="n">parameter_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">)</span>
</span><span id="line-365">            <span class="k">assert</span> <span class="n">parameter_space</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="line-366">                <span class="n">parameter_space</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="line-367">            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parameters</span><span class="p">(</span><span class="n">parameter_space</span><span class="p">)</span>
</span><span id="line-368">
</span><span id="line-369">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;set(parametername=value_array)&quot;</span><span class="p">)</span>
</span><span id="line-370">    <span class="k">def</span> <span class="nf">tset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parametername</span><span class="p">,</span> <span class="n">value_array</span><span class="p">):</span>
</span><span id="line-371"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-372"><span class="sd">        &#39;Topographic&#39; set. Set the value of parametername to the values in</span>
</span><span id="line-373"><span class="sd">        value_array, which must have the same dimensions as the Population.</span>
</span><span id="line-374"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-375">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">parametername</span><span class="p">:</span> <span class="n">value_array</span><span class="p">})</span>
</span><span id="line-376">
</span><span id="line-377">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;set(parametername=rand_distr)&quot;</span><span class="p">)</span>
</span><span id="line-378">    <span class="k">def</span> <span class="nf">rset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parametername</span><span class="p">,</span> <span class="n">rand_distr</span><span class="p">):</span>
</span><span id="line-379"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-380"><span class="sd">        &#39;Random&#39; set. Set the value of parametername to a value taken from</span>
</span><span id="line-381"><span class="sd">        rand_distr, which should be a RandomDistribution object.</span>
</span><span id="line-382"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-383">        <span class="c1"># Note that we generate enough random numbers for all cells on all nodes</span>
</span><span id="line-384">        <span class="c1"># but use only those relevant to this node. This ensures that the</span>
</span><span id="line-385">        <span class="c1"># sequence of random numbers does not depend on the number of nodes,</span>
</span><span id="line-386">        <span class="c1"># provided that the same rng with the same seed is used on each node.</span>
</span><span id="line-387">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">parametername</span><span class="p">:</span> <span class="n">rand_distr</span><span class="p">})</span>
</span><span id="line-388">
</span><span id="line-389">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">initial_values</span><span class="p">):</span>
</span><span id="line-390"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-391"><span class="sd">        Set initial values of state variables, e.g. the membrane potential.</span>
</span><span id="line-392">
</span><span id="line-393"><span class="sd">        Values passed to initialize() may be:</span>
</span><span id="line-394"><span class="sd">            (1) single numeric values (all neurons set to the same value)</span>
</span><span id="line-395"><span class="sd">            (2) RandomDistribution objects</span>
</span><span id="line-396"><span class="sd">            (3) lists/arrays of numbers of the same size as the population</span>
</span><span id="line-397"><span class="sd">            (4) mapping functions, where a mapping function accepts a single</span>
</span><span id="line-398"><span class="sd">                argument (the cell index) and returns a single number.</span>
</span><span id="line-399">
</span><span id="line-400"><span class="sd">        Values should be expressed in the standard PyNN units (i.e. millivolts,</span>
</span><span id="line-401"><span class="sd">        nanoamps, milliseconds, microsiemens, nanofarads, event per second).</span>
</span><span id="line-402">
</span><span id="line-403"><span class="sd">        Examples::</span>
</span><span id="line-404">
</span><span id="line-405"><span class="sd">            p.initialize(v=-70.0)</span>
</span><span id="line-406"><span class="sd">            p.initialize(v=rand_distr, gsyn_exc=0.0)</span>
</span><span id="line-407"><span class="sd">            p.initialize(v=lambda i: -65 + i/10.0)</span>
</span><span id="line-408"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-409">        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">initial_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="line-410">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;In Population &#39;</span><span class="si">%s</span><span class="s2">&#39;, initialising </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="line-411">                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</span><span id="line-412">            <span class="n">initial_value</span> <span class="o">=</span> <span class="n">LazyArray</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="line-413">            <span class="bp">self</span><span class="o">.</span><span class="n">_set_initial_value_array</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
</span><span id="line-414">            <span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_value</span>
</span><span id="line-415">
</span><span id="line-416">    <span class="k">def</span> <span class="nf">find_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
</span><span id="line-417"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-418"><span class="sd">        Returns units of the specified variable or parameter, as a string.</span>
</span><span id="line-419"><span class="sd">        Works for all the recordable variables and neuron parameters of all standard models.</span>
</span><span id="line-420"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-421">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="line-422">
</span><span id="line-423">    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">annotations</span><span class="p">):</span>
</span><span id="line-424">        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</span><span id="line-425">
</span><span id="line-426">    <span class="k">def</span> <span class="nf">can_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-427"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether `variable` can be recorded from this population.&quot;&quot;&quot;</span>
</span><span id="line-428">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">can_record</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
</span><span id="line-429">
</span><span id="line-430">    <span class="nd">@property</span>
</span><span id="line-431">    <span class="k">def</span> <span class="nf">injectable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-432">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">injectable</span>
</span><span id="line-433">
</span><span id="line-434">    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampling_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-435"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-436"><span class="sd">        Record the specified variable or variables for all cells in the</span>
</span><span id="line-437"><span class="sd">        Population or view.</span>
</span><span id="line-438">
</span><span id="line-439"><span class="sd">        `variables` may be either a single variable name or a list of variable</span>
</span><span id="line-440"><span class="sd">        names. For a given celltype class, `celltype.recordable` contains a list of</span>
</span><span id="line-441"><span class="sd">        variables that can be recorded for that celltype.</span>
</span><span id="line-442">
</span><span id="line-443"><span class="sd">        If specified, `to_file` should be either a filename or a Neo IO instance and `write_data()`</span>
</span><span id="line-444"><span class="sd">        will be automatically called when `end()` is called.</span>
</span><span id="line-445">
</span><span id="line-446"><span class="sd">        `sampling_interval` should be a value in milliseconds, and an integer</span>
</span><span id="line-447"><span class="sd">        multiple of the simulation timestep.</span>
</span><span id="line-448"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-449">        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># reset the list of things to record</span>
</span><span id="line-450">            <span class="c1"># note that if record(None) is called on a view of a population</span>
</span><span id="line-451">            <span class="c1"># recording will be reset for the entire population, not just the view</span>
</span><span id="line-452">            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="line-453">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-454">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.record(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
</span><span id="line-455">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-456">                <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">,</span> <span class="n">sampling_interval</span><span class="p">,</span> <span class="n">locations</span><span class="p">)</span>
</span><span id="line-457">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-458">                <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_filter</span><span class="p">,</span> <span class="n">sampling_interval</span><span class="p">,</span> <span class="n">locations</span><span class="p">)</span>
</span><span id="line-459">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-460">            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">to_file</span>
</span><span id="line-461">            <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">write_on_end</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
</span><span id="line-462">
</span><span id="line-463">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;record(&#39;v&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-464">    <span class="k">def</span> <span class="nf">record_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-465"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-466"><span class="sd">        Record the membrane potential for all cells in the Population.</span>
</span><span id="line-467"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-468">        <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span>
</span><span id="line-469">
</span><span id="line-470">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;record([&#39;gsyn_exc&#39;, &#39;gsyn_inh&#39;])&quot;</span><span class="p">)</span>
</span><span id="line-471">    <span class="k">def</span> <span class="nf">record_gsyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-472"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-473"><span class="sd">        Record synaptic conductances for all cells in the Population.</span>
</span><span id="line-474"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-475">        <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">([</span><span class="s1">&#39;gsyn_exc&#39;</span><span class="p">,</span> <span class="s1">&#39;gsyn_inh&#39;</span><span class="p">],</span> <span class="n">to_file</span><span class="p">)</span>
</span><span id="line-476">
</span><span id="line-477">    <span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-478"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-479"><span class="sd">        Write recorded data to file, using one of the file formats supported by</span>
</span><span id="line-480"><span class="sd">        Neo.</span>
</span><span id="line-481">
</span><span id="line-482"><span class="sd">        `io`:</span>
</span><span id="line-483"><span class="sd">            a Neo IO instance</span>
</span><span id="line-484"><span class="sd">        `variables`:</span>
</span><span id="line-485"><span class="sd">            either a single variable name or a list of variable names.</span>
</span><span id="line-486"><span class="sd">            Variables must have been previously recorded, otherwise an</span>
</span><span id="line-487"><span class="sd">            Exception will be raised.</span>
</span><span id="line-488">
</span><span id="line-489"><span class="sd">        For parallel simulators, if `gather` is True, all data will be gathered</span>
</span><span id="line-490"><span class="sd">        to the master node and a single output file created there. Otherwise, a</span>
</span><span id="line-491"><span class="sd">        file will be written on each node, containing only data from the cells</span>
</span><span id="line-492"><span class="sd">        simulated on that node.</span>
</span><span id="line-493">
</span><span id="line-494"><span class="sd">        If `clear` is True, recorded data will be deleted from the `Population`.</span>
</span><span id="line-495">
</span><span id="line-496"><span class="sd">        `annotations` should be a dict containing simple data types such as</span>
</span><span id="line-497"><span class="sd">        numbers and strings. The contents will be written into the output data</span>
</span><span id="line-498"><span class="sd">        file as metadata.</span>
</span><span id="line-499"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-500">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Population </span><span class="si">%s</span><span class="s2"> is writing </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> [gather=</span><span class="si">%s</span><span class="s2">, clear=</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="line-501">            <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="n">clear</span><span class="p">))</span>
</span><span id="line-502">        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_filter</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">,</span>
</span><span id="line-503">                            <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="n">locations</span><span class="p">)</span>
</span><span id="line-504">
</span><span id="line-505">    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-506"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-507"><span class="sd">        Return a Neo `Block` containing the data (spikes, state variables)</span>
</span><span id="line-508"><span class="sd">        recorded from the Population.</span>
</span><span id="line-509">
</span><span id="line-510"><span class="sd">        `variables` - either a single variable name or a list of variable names</span>
</span><span id="line-511"><span class="sd">                      Variables must have been previously recorded, otherwise an</span>
</span><span id="line-512"><span class="sd">                      Exception will be raised.</span>
</span><span id="line-513">
</span><span id="line-514"><span class="sd">        For parallel simulators, if `gather` is True, all data will be gathered</span>
</span><span id="line-515"><span class="sd">        to all nodes and the Neo `Block` will contain data from all nodes.</span>
</span><span id="line-516"><span class="sd">        Otherwise, the Neo `Block` will contain only data from the cells</span>
</span><span id="line-517"><span class="sd">        simulated on the local node.</span>
</span><span id="line-518">
</span><span id="line-519"><span class="sd">        If `clear` is True, recorded data will be deleted from the `Population`.</span>
</span><span id="line-520"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-521">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_filter</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="n">locations</span><span class="p">)</span>
</span><span id="line-522">
</span><span id="line-523">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;write_data(file, &#39;spikes&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-524">    <span class="k">def</span> <span class="nf">printSpikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-525">        <span class="bp">self</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-526">
</span><span id="line-527">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;get_data(&#39;spikes&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-528">    <span class="k">def</span> <span class="nf">getSpikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-529">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-530">
</span><span id="line-531">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;write_data(file, &#39;v&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-532">    <span class="k">def</span> <span class="nf">print_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-533">        <span class="bp">self</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-534">
</span><span id="line-535">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;get_data(&#39;v&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-536">    <span class="k">def</span> <span class="nf">get_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-537">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-538">
</span><span id="line-539">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;write_data(file, [&#39;gsyn_exc&#39;, &#39;gsyn_inh&#39;])&quot;</span><span class="p">)</span>
</span><span id="line-540">    <span class="k">def</span> <span class="nf">print_gsyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-541">        <span class="bp">self</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;gsyn_exc&#39;</span><span class="p">,</span> <span class="s1">&#39;gsyn_inh&#39;</span><span class="p">],</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-542">
</span><span id="line-543">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;get_data([&#39;gsyn_exc&#39;, &#39;gsyn_inh&#39;])&quot;</span><span class="p">)</span>
</span><span id="line-544">    <span class="k">def</span> <span class="nf">get_gsyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-545">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;gsyn_exc&#39;</span><span class="p">,</span> <span class="s1">&#39;gsyn_inh&#39;</span><span class="p">],</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-546">
</span><span id="line-547">    <span class="k">def</span> <span class="nf">get_spike_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-548"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-549"><span class="sd">        Returns a dict containing the number of spikes for each neuron.</span>
</span><span id="line-550">
</span><span id="line-551"><span class="sd">        The dict keys are neuron IDs, not indices.</span>
</span><span id="line-552"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-553">        <span class="c1"># arguably, we should use indices</span>
</span><span id="line-554">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_filter</span><span class="p">)</span>
</span><span id="line-555">
</span><span id="line-556">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;mean_spike_count()&quot;</span><span class="p">)</span>
</span><span id="line-557">    <span class="k">def</span> <span class="nf">meanSpikeCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-558">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_spike_count</span><span class="p">(</span><span class="n">gather</span><span class="p">)</span>
</span><span id="line-559">
</span><span id="line-560">    <span class="k">def</span> <span class="nf">mean_spike_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-561"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-562"><span class="sd">        Returns the mean number of spikes per neuron.</span>
</span><span id="line-563"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-564">        <span class="n">spike_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spike_counts</span><span class="p">(</span><span class="n">gather</span><span class="p">)</span>
</span><span id="line-565">        <span class="n">total_spikes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">spike_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="line-566">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">gather</span><span class="p">:</span>
</span><span id="line-567">            <span class="c1"># should maybe use allgather, and get the numbers on all nodes</span>
</span><span id="line-568">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-569">                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_spikes</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_counts</span><span class="p">)</span>
</span><span id="line-570">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-571">                <span class="k">return</span> <span class="mi">0</span>
</span><span id="line-572">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-573">            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="line-574">
</span><span id="line-575">    <span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_source</span><span class="p">):</span>
</span><span id="line-576"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-577"><span class="sd">        Connect a current source to all cells in the Population.</span>
</span><span id="line-578"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-579">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">injectable</span><span class="p">:</span>
</span><span id="line-580">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t inject current into a spike source.&quot;</span><span class="p">)</span>
</span><span id="line-581">        <span class="n">current_source</span><span class="o">.</span><span class="n">inject_into</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="line-582">
</span><span id="line-583">    <span class="c1"># name should be consistent with saving/writing data,</span>
</span><span id="line-584">    <span class="c1"># i.e. save_data() and save_positions() or write_data() and write_positions()</span>
</span><span id="line-585">    <span class="k">def</span> <span class="nf">save_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
</span><span id="line-586"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-587"><span class="sd">        Save positions to file. The output format is ``index x y z``</span>
</span><span id="line-588"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-589">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-590">            <span class="n">file</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">StandardTextFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span><span id="line-591">        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span>
</span><span id="line-592">        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="line-593">        <span class="n">result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">])</span>
</span><span id="line-594">        <span class="n">result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span>
</span><span id="line-595">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-596">            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;population&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">})</span>
</span><span id="line-597">            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="line-598">
</span><span id="line-599">
</span><span id="line-600"><span class="k">class</span> <span class="nc">Population</span><span class="p">(</span><span class="n">BasePopulation</span><span class="p">):</span>
</span><span id="line-601"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-602"><span class="sd">    A group of neurons all of the same type. &quot;Population&quot; is used as a generic</span>
</span><span id="line-603"><span class="sd">    term intended to include layers, columns, nuclei, etc., of cells.</span>
</span><span id="line-604">
</span><span id="line-605"><span class="sd">    Arguments:</span>
</span><span id="line-606"><span class="sd">        `size`:</span>
</span><span id="line-607"><span class="sd">            number of cells in the Population. For backwards-compatibility,</span>
</span><span id="line-608"><span class="sd">            `size` may also be a tuple giving the dimensions of a grid,</span>
</span><span id="line-609"><span class="sd">            e.g. ``size=(10,10)`` is equivalent to ``size=100`` with ``structure=Grid2D()``.</span>
</span><span id="line-610">
</span><span id="line-611"><span class="sd">        `cellclass`:</span>
</span><span id="line-612"><span class="sd">            a cell type (a class inheriting from :class:`pyNN.models.BaseCellType`).</span>
</span><span id="line-613">
</span><span id="line-614"><span class="sd">        `cellparams`:</span>
</span><span id="line-615"><span class="sd">            a dict, or other mapping, containing parameters, which is passed to</span>
</span><span id="line-616"><span class="sd">            the neuron model constructor.</span>
</span><span id="line-617">
</span><span id="line-618"><span class="sd">        `structure`:</span>
</span><span id="line-619"><span class="sd">            a :class:`pyNN.space.Structure` instance, used to specify the</span>
</span><span id="line-620"><span class="sd">            positions of neurons in space.</span>
</span><span id="line-621">
</span><span id="line-622"><span class="sd">        `initial_values`:</span>
</span><span id="line-623"><span class="sd">            a dict, or other mapping, containing initial values for the neuron</span>
</span><span id="line-624"><span class="sd">            state variables.</span>
</span><span id="line-625">
</span><span id="line-626"><span class="sd">        `label`:</span>
</span><span id="line-627"><span class="sd">            a name for the population. One will be auto-generated if this is not</span>
</span><span id="line-628"><span class="sd">            supplied.</span>
</span><span id="line-629"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-630">    <span class="n">_nPop</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-631">
</span><span id="line-632">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cellclass</span><span class="p">,</span> <span class="n">cellparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="line-633">                 <span class="n">initial_values</span><span class="o">=</span><span class="p">{},</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-634"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-635"><span class="sd">        Create a population of neurons all of the same type.</span>
</span><span id="line-636"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-637">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_simulator&quot;</span><span class="p">):</span>
</span><span id="line-638">            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;`common.Population` should not be instantiated directly. &quot;</span> \
</span><span id="line-639">                     <span class="s2">&quot;You should import Population from a PyNN backend module, &quot;</span> \
</span><span id="line-640">                     <span class="s2">&quot;e.g. pyNN.nest or pyNN.neuron&quot;</span>
</span><span id="line-641">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="line-642">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
</span><span id="line-643">            <span class="c1"># also allow a single integer, for a 1D population</span>
</span><span id="line-644">            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;`size` must be an integer or a tuple of ints.&quot;</span>
</span><span id="line-645">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="line-646">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err_msg</span><span class="si">}</span><span class="s2"> You have supplied a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-647">            <span class="c1"># check the things inside are ints</span>
</span><span id="line-648">            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">size</span><span class="p">:</span>
</span><span id="line-649">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="line-650">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err_msg</span><span class="si">}</span><span class="s2"> Element &#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39; is not an int&quot;</span><span class="p">)</span>
</span><span id="line-651">            <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-652">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-653">                    <span class="s2">&quot;If you specify `size` as a tuple you may not specify structure.&quot;</span><span class="p">)</span>
</span><span id="line-654">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-655">                <span class="n">structure</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">Line</span><span class="p">()</span>
</span><span id="line-656">            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="line-657">                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="line-658">                <span class="n">structure</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">Grid2D</span><span class="p">(</span><span class="n">nx</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
</span><span id="line-659">            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="line-660">                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="line-661">                <span class="n">structure</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">Grid3D</span><span class="p">(</span><span class="n">nx</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span> <span class="n">nx</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nz</span><span class="p">))</span>
</span><span id="line-662">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-663">                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="line-664">                    <span class="s2">&quot;A maximum of 3 dimensions is allowed. &quot;</span>
</span><span id="line-665">                    <span class="s2">&quot;What do you think this is, string theory?&quot;</span><span class="p">)</span>
</span><span id="line-666">            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
</span><span id="line-667">        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="line-668">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="ow">or</span> <span class="s1">&#39;population</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Population</span><span class="o">.</span><span class="n">_nPop</span>
</span><span id="line-669">        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span> <span class="ow">or</span> <span class="n">space</span><span class="o">.</span><span class="n">Line</span><span class="p">()</span>
</span><span id="line-670">        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-671">        <span class="bp">self</span><span class="o">.</span><span class="n">_is_sorted</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-672">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cellclass</span><span class="p">,</span> <span class="n">BaseCellType</span><span class="p">):</span>
</span><span id="line-673">            <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span> <span class="o">=</span> <span class="n">cellclass</span>
</span><span id="line-674">            <span class="c1"># cellparams being retained for backwards compatibility, but use is deprecated</span>
</span><span id="line-675">            <span class="k">assert</span> <span class="n">cellparams</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="line-676">        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cellclass</span><span class="p">,</span> <span class="n">BaseCellType</span><span class="p">):</span>
</span><span id="line-677">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="line-678">                <span class="s2">&quot;Passing celltype class and parameters separately is deprecated. &quot;</span>
</span><span id="line-679">                <span class="s2">&quot;Please instantiate the celltype with the parameters before &quot;</span>
</span><span id="line-680">                <span class="s2">&quot;passing to the Population&quot;</span><span class="p">,</span>
</span><span id="line-681">                <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span>
</span><span id="line-682">            <span class="p">)</span>
</span><span id="line-683">            <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span> <span class="o">=</span> <span class="n">cellclass</span><span class="p">(</span><span class="o">**</span><span class="n">cellparams</span><span class="p">)</span>
</span><span id="line-684">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-685">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-686">                <span class="s2">&quot;cellclass must be an instance or subclass of BaseCellType&quot;</span>
</span><span id="line-687">                <span class="sa">f</span><span class="s2">&quot;not a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cellclass</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-688">        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-689">        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recorder_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="line-690">        <span class="c1"># Build the arrays of cell ids</span>
</span><span id="line-691">        <span class="c1"># Cells on the local node are represented as ID objects, other cells by integers</span>
</span><span id="line-692">        <span class="c1"># All are stored in a single numpy array for easy lookup by address</span>
</span><span id="line-693">        <span class="c1"># The local cells are also stored in a list, for easy iteration</span>
</span><span id="line-694">        <span class="bp">self</span><span class="o">.</span><span class="n">_create_cells</span><span class="p">()</span>
</span><span id="line-695">        <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-696">        <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="line-697">        <span class="bp">self</span><span class="o">.</span><span class="n">initial_values</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-698">        <span class="n">all_initial_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">default_initial_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-699">        <span class="n">all_initial_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">initial_values</span><span class="p">)</span>
</span><span id="line-700">        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">all_initial_values</span><span class="p">)</span>
</span><span id="line-701">        <span class="n">Population</span><span class="o">.</span><span class="n">_nPop</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-702">
</span><span id="line-703">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-704">        <span class="k">return</span> <span class="s2">&quot;Population(</span><span class="si">%d</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, structure=</span><span class="si">%r</span><span class="s2">, label=</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="line-705">            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</span><span id="line-706">
</span><span id="line-707">    <span class="nd">@property</span>
</span><span id="line-708">    <span class="k">def</span> <span class="nf">local_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-709"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-710"><span class="sd">        An array containing cell ids for the local node.</span>
</span><span id="line-711"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-712">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">]</span>
</span><span id="line-713">
<div class="viewcode-block" id="Population.id_to_index">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Population.id_to_index">[docs]</a>
</span><span id="line-714">    <span class="k">def</span> <span class="nf">id_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="line-715"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-716"><span class="sd">        Given the ID(s) of cell(s) in the Population, return its (their) index</span>
</span><span id="line-717"><span class="sd">        (order in the Population).</span>
</span><span id="line-718">
</span><span id="line-719"><span class="sd">            &gt;&gt;&gt; assert p.id_to_index(p[5]) == 5</span>
</span><span id="line-720"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-721">        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">iterable</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span id="line-722">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span> <span class="o">&lt;=</span> <span class="nb">id</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">:</span>
</span><span id="line-723">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;id should be in the range [</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">], actually </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="line-724">                    <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>
</span><span id="line-725">            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span><span class="p">)</span>  <span class="c1"># this assumes ids are consecutive</span>
</span><span id="line-726">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-727">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">PopulationView</span><span class="p">):</span>
</span><span id="line-728">                <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">all_cells</span>
</span><span id="line-729">            <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="line-730">            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_id</span> <span class="o">&gt;</span> <span class="nb">id</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_id</span> <span class="o">&lt;</span> <span class="nb">id</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
</span><span id="line-731">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ids should be in the range [</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">], actually [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="line-732">                    <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">,</span> <span class="nb">id</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="nb">id</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</span><span id="line-733">            <span class="k">return</span> <span class="p">(</span><span class="nb">id</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># this assumes ids are consecutive</span></div>

</span><span id="line-734">
<div class="viewcode-block" id="Population.id_to_local_index">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Population.id_to_local_index">[docs]</a>
</span><span id="line-735">    <span class="k">def</span> <span class="nf">id_to_local_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="line-736"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-737"><span class="sd">        Given the ID(s) of cell(s) in the Population, return its (their) index</span>
</span><span id="line-738"><span class="sd">        (order in the Population), counting only cells on the local MPI node.</span>
</span><span id="line-739"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-740">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-741">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>          <span class="c1"># probably very slow</span>
</span><span id="line-742">            <span class="c1"># return np.nonzero(self.local_cells == id)[0][0] # possibly faster?</span>
</span><span id="line-743">            <span class="c1"># another idea - get global index, use idx-sum(mask_local[:idx])?</span>
</span><span id="line-744">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-745">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></div>

</span><span id="line-746">
</span><span id="line-747">    <span class="k">def</span> <span class="nf">_get_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-748"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The spatial structure of the Population.&quot;&quot;&quot;</span>
</span><span id="line-749">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>
</span><span id="line-750">
</span><span id="line-751">    <span class="k">def</span> <span class="nf">_set_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
</span><span id="line-752">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">space</span><span class="o">.</span><span class="n">BaseStructure</span><span class="p">)</span>
</span><span id="line-753">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">structure</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">:</span>
</span><span id="line-754">            <span class="c1"># setting a new structure invalidates previously calculated positions</span>
</span><span id="line-755">            <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-756">            <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
</span><span id="line-757">    <span class="n">structure</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">fget</span><span class="o">=</span><span class="n">_get_structure</span><span class="p">,</span> <span class="n">fset</span><span class="o">=</span><span class="n">_set_structure</span><span class="p">)</span>
</span><span id="line-758">    <span class="c1"># arguably structure should be read-only,</span>
</span><span id="line-759">    <span class="c1"># i.e. it is not possible to change it after Population creation</span>
</span><span id="line-760">
</span><span id="line-761">    <span class="k">def</span> <span class="nf">_get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-762"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-763"><span class="sd">        Try to return self._positions. If it does not exist, create it and then</span>
</span><span id="line-764"><span class="sd">        return it.</span>
</span><span id="line-765"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-766">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-767">            <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">generate_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="line-768">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="line-769">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span>
</span><span id="line-770">
</span><span id="line-771">    <span class="k">def</span> <span class="nf">_set_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_array</span><span class="p">):</span>
</span><span id="line-772">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="line-773">        <span class="k">assert</span> <span class="n">pos_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
</span><span id="line-774">        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="n">pos_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># take a copy in case pos_array is changed later</span>
</span><span id="line-775">        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># explicitly setting positions destroys any previous structure</span>
</span><span id="line-776">
</span><span id="line-777">    <span class="n">positions</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_positions</span><span class="p">,</span> <span class="n">_set_positions</span><span class="p">,</span>
</span><span id="line-778">                         <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;A 3xN array (where N is the number of neurons in the Population)</span>
</span><span id="line-779"><span class="s2">                         giving the x,y,z coordinates of all the neurons (soma, in the</span>
</span><span id="line-780"><span class="s2">                         case of non-point models).&quot;&quot;&quot;</span><span class="p">)</span>
</span><span id="line-781">
<div class="viewcode-block" id="Population.describe">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Population.describe">[docs]</a>
</span><span id="line-782">    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;population_default.txt&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
</span><span id="line-783"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-784"><span class="sd">        Returns a human-readable description of the population.</span>
</span><span id="line-785">
</span><span id="line-786"><span class="sd">        The output may be customized by specifying a different template</span>
</span><span id="line-787"><span class="sd">        together with an associated template engine (see :mod:`pyNN.descriptions`).</span>
</span><span id="line-788">
</span><span id="line-789"><span class="sd">        If template is None, then a dictionary containing the template context</span>
</span><span id="line-790"><span class="sd">        will be returned.</span>
</span><span id="line-791"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-792">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="line-793">            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
</span><span id="line-794">            <span class="s2">&quot;celltype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
</span><span id="line-795">            <span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-796">            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="line-797">            <span class="s2">&quot;size_local&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span><span class="p">),</span>
</span><span id="line-798">            <span class="s2">&quot;first_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span><span class="p">,</span>
</span><span id="line-799">            <span class="s2">&quot;last_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span><span class="p">,</span>
</span><span id="line-800">        <span class="p">}</span>
</span><span id="line-801">        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>
</span><span id="line-802">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-803">            <span class="n">first_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-804">            <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="line-805">                <span class="s2">&quot;local_first_id&quot;</span><span class="p">:</span> <span class="n">first_id</span><span class="p">,</span>
</span><span id="line-806">                <span class="s2">&quot;cell_parameters&quot;</span><span class="p">:</span> <span class="p">{}</span>  <span class="c1"># first_id.get_parameters(),</span>
</span><span id="line-807">            <span class="p">})</span>
</span><span id="line-808">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span>
</span><span id="line-809">            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="line-810">        <span class="k">return</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

</span><span id="line-811">
</span><span id="line-812">
</span><span id="line-813"><span class="k">class</span> <span class="nc">PopulationView</span><span class="p">(</span><span class="n">BasePopulation</span><span class="p">):</span>
</span><span id="line-814"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-815"><span class="sd">    A view of a subset of neurons within a Population.</span>
</span><span id="line-816">
</span><span id="line-817"><span class="sd">    In most ways, Populations and PopulationViews have the same behaviour, i.e.</span>
</span><span id="line-818"><span class="sd">    they can be recorded, connected with Projections, etc. It should be noted</span>
</span><span id="line-819"><span class="sd">    that any changes to neurons in a PopulationView will be reflected in the</span>
</span><span id="line-820"><span class="sd">    parent Population and vice versa.</span>
</span><span id="line-821">
</span><span id="line-822"><span class="sd">    It is possible to have views of views.</span>
</span><span id="line-823">
</span><span id="line-824"><span class="sd">    Arguments:</span>
</span><span id="line-825"><span class="sd">        selector:</span>
</span><span id="line-826"><span class="sd">            a slice or numpy mask array. The mask array should either be a</span>
</span><span id="line-827"><span class="sd">            boolean array of the same size as the parent, or an integer array</span>
</span><span id="line-828"><span class="sd">            containing cell indices, i.e. if p.size == 5::</span>
</span><span id="line-829">
</span><span id="line-830"><span class="sd">                PopulationView(p, array([False, False, True, False, True]))</span>
</span><span id="line-831"><span class="sd">                PopulationView(p, array([2,4]))</span>
</span><span id="line-832"><span class="sd">                PopulationView(p, slice(2,5,2))</span>
</span><span id="line-833">
</span><span id="line-834"><span class="sd">            will all create the same view.</span>
</span><span id="line-835"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-836">
</span><span id="line-837">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-838"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-839"><span class="sd">        Create a view of a subset of neurons within a parent Population or</span>
</span><span id="line-840"><span class="sd">        PopulationView.</span>
</span><span id="line-841"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-842">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_simulator&quot;</span><span class="p">):</span>
</span><span id="line-843">            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;`common.PopulationView` should not be instantiated directly. &quot;</span> \
</span><span id="line-844">                     <span class="s2">&quot;You should import PopulationView from a PyNN backend module, &quot;</span> \
</span><span id="line-845">                     <span class="s2">&quot;e.g. pyNN.nest or pyNN.neuron&quot;</span>
</span><span id="line-846">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="line-847">        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="line-848">        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">selector</span>
</span><span id="line-849">        <span class="c1"># later we can have fancier selectors, for now we just have numpy masks</span>
</span><span id="line-850">        <span class="c1"># maybe just redefine __getattr__ instead of the following...</span>
</span><span id="line-851">        <span class="bp">self</span><span class="o">.</span><span class="n">celltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">celltype</span>
</span><span id="line-852">        <span class="c1"># If the mask is a slice, IDs will be consecutives without duplication.</span>
</span><span id="line-853">        <span class="c1"># If not, then we need to remove duplicated IDs</span>
</span><span id="line-854">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="line-855">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="line-856">                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
</span><span id="line-857">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">):</span>
</span><span id="line-858">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
</span><span id="line-859">                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Boolean masks should have the size of Parent Population&quot;</span><span class="p">)</span>
</span><span id="line-860">                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">))[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
</span><span id="line-861">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-862">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">):</span>
</span><span id="line-863">                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="line-864">                        <span class="s2">&quot;PopulationView can contain each ID only once, duplicates are removed&quot;</span><span class="p">)</span>
</span><span id="line-865">                    <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
</span><span id="line-866">                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># needed by NEST.</span>
</span><span id="line-867">                <span class="c1"># Maybe emit a warning or exception if mask is not already ordered?</span>
</span><span id="line-868">        <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">all_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
</span><span id="line-869">        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-870">        <span class="bp">self</span><span class="o">.</span><span class="n">_is_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)))</span>
</span><span id="line-871">        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-872">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="ow">or</span> <span class="s2">&quot;view of &#39;</span><span class="si">%s</span><span class="s2">&#39; with size </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="line-873">        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
</span><span id="line-874">        <span class="bp">self</span><span class="o">.</span><span class="n">local_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">]</span>
</span><span id="line-875">        <span class="c1"># only works if we assume all_cells is sorted, otherwise could use min()</span>
</span><span id="line-876">        <span class="bp">self</span><span class="o">.</span><span class="n">first_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-877">        <span class="bp">self</span><span class="o">.</span><span class="n">last_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-878">        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-879">        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">recorder</span>
</span><span id="line-880">        <span class="bp">self</span><span class="o">.</span><span class="n">_record_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span>
</span><span id="line-881">
</span><span id="line-882">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-883">        <span class="k">return</span> <span class="s2">&quot;PopulationView(parent=</span><span class="si">%r</span><span class="s2">, selector=</span><span class="si">%r</span><span class="s2">, label=</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="line-884">            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</span><span id="line-885">
</span><span id="line-886">    <span class="nd">@property</span>
</span><span id="line-887">    <span class="k">def</span> <span class="nf">initial_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-888">        <span class="c1"># this is going to be complex - if we keep initial_values as a dict,</span>
</span><span id="line-889">        <span class="c1"># need to return a dict-like object that takes account of self.mask</span>
</span><span id="line-890">        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="line-891">
</span><span id="line-892">    <span class="nd">@property</span>
</span><span id="line-893">    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-894"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The spatial structure of the parent Population.&quot;&quot;&quot;</span>
</span><span id="line-895">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">structure</span>
</span><span id="line-896">    <span class="c1"># should we allow setting structure for a PopulationView? Maybe if the</span>
</span><span id="line-897">    <span class="c1"># parent has some kind of CompositeStructure?</span>
</span><span id="line-898">
</span><span id="line-899">    <span class="nd">@property</span>
</span><span id="line-900">    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-901">        <span class="c1"># make positions N,3 instead of 3,N to avoid all this transposing?</span>
</span><span id="line-902">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="line-903">
<div class="viewcode-block" id="PopulationView.id_to_index">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.PopulationView.id_to_index">[docs]</a>
</span><span id="line-904">    <span class="k">def</span> <span class="nf">id_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="line-905"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-906"><span class="sd">        Given the ID(s) of cell(s) in the PopulationView, return its/their</span>
</span><span id="line-907"><span class="sd">        index/indices (order in the PopulationView).</span>
</span><span id="line-908">
</span><span id="line-909"><span class="sd">            &gt;&gt;&gt; assert pv.id_to_index(pv[3]) == 3</span>
</span><span id="line-910"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-911">        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">iterable</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span id="line-912">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sorted</span><span class="p">:</span>
</span><span id="line-913">                <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">:</span>
</span><span id="line-914">                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> not present in the View&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-915">                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-916">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-917">                <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-918">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-919">                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> not present in the View&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-920">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-921">                <span class="k">return</span> <span class="n">result</span>
</span><span id="line-922">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-923">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sorted</span><span class="p">:</span>
</span><span id="line-924">                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-925">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-926">                <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="line-927">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="line-928">                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-929">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-930">                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> not present in the View&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
</span><span id="line-931">                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-932">                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> is duplicated in the View&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
</span><span id="line-933">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-934">                        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="line-935">                <span class="k">return</span> <span class="n">result</span></div>

</span><span id="line-936">
</span><span id="line-937">    <span class="nd">@property</span>
</span><span id="line-938">    <span class="k">def</span> <span class="nf">grandparent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-939"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-940"><span class="sd">        Returns the parent Population at the root of the tree (since the</span>
</span><span id="line-941"><span class="sd">        immediate parent may itself be a PopulationView).</span>
</span><span id="line-942">
</span><span id="line-943"><span class="sd">        The name &quot;grandparent&quot; is of course a little misleading, as it could</span>
</span><span id="line-944"><span class="sd">        be just the parent, or the great, great, great, ..., grandparent.</span>
</span><span id="line-945"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-946">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;parent&quot;</span><span class="p">):</span>
</span><span id="line-947">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">grandparent</span>
</span><span id="line-948">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-949">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
</span><span id="line-950">
<div class="viewcode-block" id="PopulationView.index_in_grandparent">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.PopulationView.index_in_grandparent">[docs]</a>
</span><span id="line-951">    <span class="k">def</span> <span class="nf">index_in_grandparent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="line-952"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-953"><span class="sd">        Given an array of indices, return the indices in the parent population</span>
</span><span id="line-954"><span class="sd">        at the root of the tree.</span>
</span><span id="line-955"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-956">        <span class="n">indices_in_parent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
</span><span id="line-957">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;parent&quot;</span><span class="p">):</span>
</span><span id="line-958">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">index_in_grandparent</span><span class="p">(</span><span class="n">indices_in_parent</span><span class="p">)</span>
</span><span id="line-959">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-960">            <span class="k">return</span> <span class="n">indices_in_parent</span></div>

</span><span id="line-961">
<div class="viewcode-block" id="PopulationView.index_from_parent_index">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.PopulationView.index_from_parent_index">[docs]</a>
</span><span id="line-962">    <span class="k">def</span> <span class="nf">index_from_parent_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="line-963"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-964"><span class="sd">        Given an index(indices) in the parent population, return</span>
</span><span id="line-965"><span class="sd">        the index(indices) within this view.</span>
</span><span id="line-966"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-967">        <span class="c1"># todo: add check that all indices correspond to cells that are in this view</span>
</span><span id="line-968">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
</span><span id="line-969">            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
</span><span id="line-970">            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span>
</span><span id="line-971">            <span class="k">return</span> <span class="p">(</span><span class="n">indices</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span>
</span><span id="line-972">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-973">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="line-974">                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="n">indices</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-975">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="line-976">                <span class="c1"># Lots of ways to do this. Some profiling is in order.</span>
</span><span id="line-977">                <span class="c1"># - https://stackoverflow.com/questions/16992713/translate-every-element-in-numpy-array-according-to-key  # noqa:E501</span>
</span><span id="line-978">                <span class="c1"># - https://stackoverflow.com/questions/3403973/fast-replacement-of-values-in-a-numpy-array  # noqa:E501</span>
</span><span id="line-979">                <span class="c1"># - https://stackoverflow.com/questions/13572448/replace-values-of-a-numpy-index-array-with-values-of-a-list  # noqa:E501</span>
</span><span id="line-980">                <span class="n">parent_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>  <span class="c1"># assert mask is sorted</span>
</span><span id="line-981">                <span class="n">view_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="line-982">                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">parent_indices</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-983">                <span class="k">return</span> <span class="n">view_indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="line-984">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-985">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;indices must be an integer or an array of integers&quot;</span><span class="p">)</span></div>

</span><span id="line-986">
</span><span id="line-987">    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="line-988"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-989"><span class="sd">        Determine whether two views are the same.</span>
</span><span id="line-990"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-991">        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="line-992">
</span><span id="line-993">    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="line-994"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-995"><span class="sd">        Determine whether two views are different.</span>
</span><span id="line-996"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-997">        <span class="c1"># We can&#39;t use the self.mask, as different masks can select the same cells</span>
</span><span id="line-998">        <span class="c1"># (e.g. slices vs arrays), therefore we have to use self.all_cells</span>
</span><span id="line-999">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PopulationView</span><span class="p">):</span>
</span><span id="line-1000">            <span class="k">return</span> <span class="p">(</span>
</span><span id="line-1001">                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">parent</span>
</span><span id="line-1002">                <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-1003">            <span class="p">)</span>
</span><span id="line-1004">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Population</span><span class="p">):</span>
</span><span id="line-1005">            <span class="k">return</span> <span class="p">(</span>
</span><span id="line-1006">                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">other</span>
</span><span id="line-1007">                <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-1008">            <span class="p">)</span>
</span><span id="line-1009">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1010">            <span class="k">return</span> <span class="kc">True</span>
</span><span id="line-1011">
<div class="viewcode-block" id="PopulationView.describe">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.PopulationView.describe">[docs]</a>
</span><span id="line-1012">    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;populationview_default.txt&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
</span><span id="line-1013"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1014"><span class="sd">        Returns a human-readable description of the population view.</span>
</span><span id="line-1015">
</span><span id="line-1016"><span class="sd">        The output may be customized by specifying a different template</span>
</span><span id="line-1017"><span class="sd">        togther with an associated template engine (see ``pyNN.descriptions``).</span>
</span><span id="line-1018">
</span><span id="line-1019"><span class="sd">        If template is None, then a dictionary containing the template context</span>
</span><span id="line-1020"><span class="sd">        will be returned.</span>
</span><span id="line-1021"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1022">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
</span><span id="line-1023">                   <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
</span><span id="line-1024">                   <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
</span><span id="line-1025">                   <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">}</span>
</span><span id="line-1026">        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>
</span><span id="line-1027">        <span class="k">return</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

</span><span id="line-1028">
</span><span id="line-1029">
</span><span id="line-1030"><span class="k">class</span> <span class="nc">Assembly</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="line-1031"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1032"><span class="sd">    A group of neurons, may be heterogeneous, in contrast to a Population where</span>
</span><span id="line-1033"><span class="sd">    all the neurons are of the same type.</span>
</span><span id="line-1034">
</span><span id="line-1035"><span class="sd">    Arguments:</span>
</span><span id="line-1036"><span class="sd">        populations:</span>
</span><span id="line-1037"><span class="sd">            Populations or PopulationViews</span>
</span><span id="line-1038"><span class="sd">        kwargs:</span>
</span><span id="line-1039"><span class="sd">            May contain a keyword argument &#39;label&#39;</span>
</span><span id="line-1040"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-1041">    <span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-1042">
</span><span id="line-1043">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">populations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1044"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1045"><span class="sd">        Create an Assembly of Populations and/or PopulationViews.</span>
</span><span id="line-1046"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1047">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_simulator&quot;</span><span class="p">):</span>
</span><span id="line-1048">            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;`common.Assembly` should not be instantiated directly. &quot;</span> \
</span><span id="line-1049">                     <span class="s2">&quot;You should import Assembly from a PyNN backend module, &quot;</span> \
</span><span id="line-1050">                     <span class="s2">&quot;e.g. pyNN.nest or pyNN.neuron&quot;</span>
</span><span id="line-1051">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="line-1052">        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="line-1053">            <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
</span><span id="line-1054">        <span class="bp">self</span><span class="o">.</span><span class="n">populations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-1055">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">populations</span><span class="p">:</span>
</span><span id="line-1056">            <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="line-1057">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;assembly</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Assembly</span><span class="o">.</span><span class="n">_count</span><span class="p">)</span>
</span><span id="line-1058">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;label must be a string&quot;</span>
</span><span id="line-1059">        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-1060">        <span class="n">Assembly</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-1061">
</span><span id="line-1062">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1063">        <span class="k">return</span> <span class="s2">&quot;Assembly(*</span><span class="si">%r</span><span class="s2">, label=</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
</span><span id="line-1064">
</span><span id="line-1065">    <span class="k">def</span> <span class="nf">_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
</span><span id="line-1066">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BasePopulation</span><span class="p">):</span>
</span><span id="line-1067">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;argument is a </span><span class="si">%s</span><span class="s2">, not a Population.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="line-1068">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">PopulationView</span><span class="p">):</span>
</span><span id="line-1069">            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1070">                <span class="n">double</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-1071">                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1072">                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">all_cells</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">all_cells</span><span class="p">))</span>
</span><span id="line-1073">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">all_cells</span><span class="p">):</span>
</span><span id="line-1074">                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="line-1075">                            <span class="s1">&#39;Cannnot add a PopulationView to an Assembly &#39;</span>
</span><span id="line-1076">                            <span class="s1">&#39;containing elements already present&#39;</span><span class="p">)</span>
</span><span id="line-1077">                        <span class="n">double</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Should we automatically remove duplicated IDs ?</span>
</span><span id="line-1078">                        <span class="k">break</span>
</span><span id="line-1079">                <span class="k">if</span> <span class="ow">not</span> <span class="n">double</span><span class="p">:</span>
</span><span id="line-1080">                    <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="line-1081">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1082">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="line-1083">                    <span class="s1">&#39;Cannot add a PopulationView to an Assembly when parent Population is there&#39;</span><span class="p">)</span>
</span><span id="line-1084">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BasePopulation</span><span class="p">):</span>
</span><span id="line-1085">            <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1086">                <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span><span id="line-1087">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1088">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Adding a Population twice in an Assembly is not possible&#39;</span><span class="p">)</span>
</span><span id="line-1089">
</span><span id="line-1090">    <span class="nd">@property</span>
</span><span id="line-1091">    <span class="k">def</span> <span class="nf">local_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1092">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">local_cells</span>
</span><span id="line-1093">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1094">            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">local_cells</span><span class="p">))</span>
</span><span id="line-1095">        <span class="k">return</span> <span class="n">result</span>
</span><span id="line-1096">
</span><span id="line-1097">    <span class="nd">@property</span>
</span><span id="line-1098">    <span class="k">def</span> <span class="nf">all_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1099">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all_cells</span>
</span><span id="line-1100">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1101">            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">all_cells</span><span class="p">))</span>
</span><span id="line-1102">        <span class="k">return</span> <span class="n">result</span>
</span><span id="line-1103">
<div class="viewcode-block" id="Assembly.all">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.all">[docs]</a>
</span><span id="line-1104">    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1105"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterator over cell ids on all nodes.&quot;&quot;&quot;</span>
</span><span id="line-1106">        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span></div>

</span><span id="line-1107">
</span><span id="line-1108">    <span class="nd">@property</span>
</span><span id="line-1109">    <span class="k">def</span> <span class="nf">_is_sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1110">        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-1111">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)))</span>
</span><span id="line-1112">
</span><span id="line-1113">    <span class="nd">@property</span>
</span><span id="line-1114">    <span class="k">def</span> <span class="nf">_homogeneous_synapses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1115">        <span class="n">cb</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">conductance_based</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">]</span>
</span><span id="line-1116">        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
</span><span id="line-1117">
</span><span id="line-1118">    <span class="nd">@property</span>
</span><span id="line-1119">    <span class="k">def</span> <span class="nf">conductance_based</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1120"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1121"><span class="sd">        `True` if the post-synaptic response is modelled as a change</span>
</span><span id="line-1122"><span class="sd">        in conductance, `False` if a change in current.</span>
</span><span id="line-1123"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1124">        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">conductance_based</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">)</span>
</span><span id="line-1125">
</span><span id="line-1126">    <span class="nd">@property</span>
</span><span id="line-1127">    <span class="k">def</span> <span class="nf">receptor_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1128"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1129"><span class="sd">        Return a list of receptor types that are common to all populations</span>
</span><span id="line-1130"><span class="sd">        within the assembly.</span>
</span><span id="line-1131"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1132">        <span class="n">rts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">receptor_types</span>
</span><span id="line-1133">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-1134">            <span class="n">rts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rts</span><span class="p">)</span>
</span><span id="line-1135">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1136">                <span class="n">rts</span> <span class="o">=</span> <span class="n">rts</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">receptor_types</span><span class="p">))</span>
</span><span id="line-1137">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">rts</span><span class="p">)</span>
</span><span id="line-1138">
<div class="viewcode-block" id="Assembly.find_units">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.find_units">[docs]</a>
</span><span id="line-1139">    <span class="k">def</span> <span class="nf">find_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
</span><span id="line-1140"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1141"><span class="sd">        Returns units of the specified variable or parameter, as a string.</span>
</span><span id="line-1142"><span class="sd">        Works for all the recordable variables and neuron parameters of all standard models.</span>
</span><span id="line-1143"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1144">        <span class="n">units</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">find_units</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">)</span>
</span><span id="line-1145">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-1146">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent units&quot;</span><span class="p">)</span>
</span><span id="line-1147">        <span class="k">return</span> <span class="n">units</span></div>

</span><span id="line-1148">
</span><span id="line-1149">    <span class="nd">@property</span>
</span><span id="line-1150">    <span class="k">def</span> <span class="nf">_mask_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1151">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_mask_local</span>
</span><span id="line-1152">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1153">            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">_mask_local</span><span class="p">))</span>
</span><span id="line-1154">        <span class="k">return</span> <span class="n">result</span>
</span><span id="line-1155">
</span><span id="line-1156">    <span class="nd">@property</span>
</span><span id="line-1157">    <span class="k">def</span> <span class="nf">first_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1158">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-1159">
</span><span id="line-1160">    <span class="nd">@property</span>
</span><span id="line-1161">    <span class="k">def</span> <span class="nf">last_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1162">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span><span class="p">)</span>
</span><span id="line-1163">
<div class="viewcode-block" id="Assembly.id_to_index">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.id_to_index">[docs]</a>
</span><span id="line-1164">    <span class="k">def</span> <span class="nf">id_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="line-1165"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1166"><span class="sd">        Given the ID(s) of cell(s) in the Assembly, return its (their) index</span>
</span><span id="line-1167"><span class="sd">        (order in the Assembly)::</span>
</span><span id="line-1168">
</span><span id="line-1169"><span class="sd">            &gt;&gt;&gt; assert p.id_to_index(p[5]) == 5</span>
</span><span id="line-1170"><span class="sd">            &gt;&gt;&gt; assert p.id_to_index(p.index([1, 2, 3])) == [1, 2, 3]</span>
</span><span id="line-1171"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1172">        <span class="n">all_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span>
</span><span id="line-1173">        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">iterable</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span id="line-1174">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sorted</span><span class="p">:</span>
</span><span id="line-1175">                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">all_cells</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-1176">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1177">                <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_cells</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1178">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-1179">                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> not present in the View&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-1180">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1181">                <span class="k">return</span> <span class="n">result</span>
</span><span id="line-1182">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1183">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_sorted</span><span class="p">:</span>
</span><span id="line-1184">                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">all_cells</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span id="line-1185">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1186">                <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="line-1187">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="line-1188">                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_cells</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1189">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-1190">                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> not present in the Assembly&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
</span><span id="line-1191">                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-1192">                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> is duplicated in the Assembly&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
</span><span id="line-1193">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-1194">                        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="line-1195">                <span class="k">return</span> <span class="n">result</span></div>

</span><span id="line-1196">
</span><span id="line-1197">    <span class="nd">@property</span>
</span><span id="line-1198">    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1199">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span>
</span><span id="line-1200">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1201">            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">positions</span><span class="p">))</span>
</span><span id="line-1202">        <span class="k">return</span> <span class="n">result</span>
</span><span id="line-1203">
</span><span id="line-1204">    <span class="nd">@property</span>
</span><span id="line-1205">    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1206">        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">)</span>
</span><span id="line-1207">
<div class="viewcode-block" id="Assembly.__iter__">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.__iter__">[docs]</a>
</span><span id="line-1208">    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1209"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1210"><span class="sd">        Iterator over cells in all populations within the Assembly, for cells</span>
</span><span id="line-1211"><span class="sd">        on the local MPI node.</span>
</span><span id="line-1212"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1213">        <span class="n">iterators</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">]</span>
</span><span id="line-1214">        <span class="k">return</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">iterators</span><span class="p">)</span></div>

</span><span id="line-1215">
<div class="viewcode-block" id="Assembly.__len__">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.__len__">[docs]</a>
</span><span id="line-1216">    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1217"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the total number of cells in the population (all nodes).&quot;&quot;&quot;</span>
</span><span id="line-1218">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span></div>

</span><span id="line-1219">
<div class="viewcode-block" id="Assembly.__getitem__">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.__getitem__">[docs]</a>
</span><span id="line-1220">    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="line-1221"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1222"><span class="sd">        Where `index` is an integer, return an ID.</span>
</span><span id="line-1223"><span class="sd">        Where `index` is a slice, tuple, list or numpy array, return a new Assembly</span>
</span><span id="line-1224"><span class="sd">        consisting of appropriate populations and (possibly newly created)</span>
</span><span id="line-1225"><span class="sd">        population views.</span>
</span><span id="line-1226"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1227">        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-1228">        <span class="n">boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1229">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1230">            <span class="n">count</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span>
</span><span id="line-1231">            <span class="n">boundaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span><span id="line-1232">        <span class="n">boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="line-1233">
</span><span id="line-1234">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>  <span class="c1"># return an ID</span>
</span><span id="line-1235">            <span class="n">pindex</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="line-1236">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="n">pindex</span><span class="p">][</span><span class="n">index</span> <span class="o">-</span> <span class="n">boundaries</span><span class="p">[</span><span class="n">pindex</span><span class="p">]]</span>
</span><span id="line-1237">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
</span><span id="line-1238">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="line-1239">                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
</span><span id="line-1240">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1241">                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span id="line-1242">            <span class="n">pindices</span> <span class="o">=</span> <span class="n">boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
</span><span id="line-1243">            <span class="n">views</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indices</span><span class="p">[</span><span class="n">pindices</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span><span id="line-1244">                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pindices</span><span class="p">)]</span>
</span><span id="line-1245">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="n">views</span><span class="p">)</span>
</span><span id="line-1246">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1247">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;indices must be integers, slices, lists, arrays, not </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
</span><span id="line-1248">                            <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>

</span><span id="line-1249">
<div class="viewcode-block" id="Assembly.__add__">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.__add__">[docs]</a>
</span><span id="line-1250">    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="line-1251"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1252"><span class="sd">        An Assembly may be added to a Population, PopulationView or Assembly</span>
</span><span id="line-1253"><span class="sd">        with the &#39;+&#39; operator, returning a new Assembly, e.g.::</span>
</span><span id="line-1254">
</span><span id="line-1255"><span class="sd">            a2 = a1 + p</span>
</span><span id="line-1256"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1257">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BasePopulation</span><span class="p">):</span>
</span><span id="line-1258">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">populations</span> <span class="o">+</span> <span class="p">[</span><span class="n">other</span><span class="p">]))</span>
</span><span id="line-1259">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>
</span><span id="line-1260">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">populations</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">populations</span><span class="p">))</span>
</span><span id="line-1261">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1262">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can only add a Population or another Assembly to an Assembly&quot;</span><span class="p">)</span></div>

</span><span id="line-1263">
<div class="viewcode-block" id="Assembly.__iadd__">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.__iadd__">[docs]</a>
</span><span id="line-1264">    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="line-1265"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1266"><span class="sd">        A Population, PopulationView or Assembly may be added to an existing</span>
</span><span id="line-1267"><span class="sd">        Assembly using the &#39;+=&#39; operator, e.g.::</span>
</span><span id="line-1268">
</span><span id="line-1269"><span class="sd">            a += p</span>
</span><span id="line-1270"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1271">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BasePopulation</span><span class="p">):</span>
</span><span id="line-1272">            <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="line-1273">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>
</span><span id="line-1274">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1275">                <span class="bp">self</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="line-1276">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1277">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can only add a Population or another Assembly to an Assembly&quot;</span><span class="p">)</span>
</span><span id="line-1278">        <span class="k">return</span> <span class="bp">self</span></div>

</span><span id="line-1279">
<div class="viewcode-block" id="Assembly.sample">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.sample">[docs]</a>
</span><span id="line-1280">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1281"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1282"><span class="sd">        Randomly sample `n` cells from the Assembly, and return a Assembly</span>
</span><span id="line-1283"><span class="sd">        object.</span>
</span><span id="line-1284"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1285">        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</span><span id="line-1286">        <span class="k">if</span> <span class="ow">not</span> <span class="n">rng</span><span class="p">:</span>
</span><span id="line-1287">            <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">NumpyRNG</span><span class="p">()</span>
</span><span id="line-1288">        <span class="n">indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
</span><span id="line-1289">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The </span><span class="si">%d</span><span class="s2"> cells recorded have indices </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">indices</span><span class="p">))</span>
</span><span id="line-1290">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.sample(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="line-1291">        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span></div>

</span><span id="line-1292">
<div class="viewcode-block" id="Assembly.initialize">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.initialize">[docs]</a>
</span><span id="line-1293">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">initial_values</span><span class="p">):</span>
</span><span id="line-1294"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1295"><span class="sd">        Set the initial values of the state variables of the neurons in</span>
</span><span id="line-1296"><span class="sd">        this assembly.</span>
</span><span id="line-1297"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1298">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1299">            <span class="n">p</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">initial_values</span><span class="p">)</span></div>

</span><span id="line-1300">
<div class="viewcode-block" id="Assembly.get">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.get">[docs]</a>
</span><span id="line-1301">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_names</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1302"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1303"><span class="sd">        Get the values of the given parameters for every local cell in the</span>
</span><span id="line-1304"><span class="sd">        Assembly, or, if gather=True, for all cells in the Assembly.</span>
</span><span id="line-1305"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1306">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-1307">            <span class="n">parameter_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameter_names</span><span class="p">,)</span>
</span><span id="line-1308">            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-1309">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1310">            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1311">
</span><span id="line-1312">        <span class="n">parameters</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="line-1313">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1314">            <span class="n">population_values</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="line-1315">            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">,</span> <span class="n">population_values</span><span class="p">):</span>
</span><span id="line-1316">                <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</span><span id="line-1317">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value_list</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="line-1318">            <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">value_list</span><span class="p">)</span>
</span><span id="line-1319">            <span class="k">if</span> <span class="n">simplify</span><span class="p">:</span>
</span><span id="line-1320">                <span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">simplify_parameter_array</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
</span><span id="line-1321">        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parameter_names</span><span class="p">]</span>
</span><span id="line-1322">        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
</span><span id="line-1323">            <span class="k">return</span> <span class="n">values</span>
</span><span id="line-1324">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1325">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="line-1326">            <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

</span><span id="line-1327">
<div class="viewcode-block" id="Assembly.set">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.set">[docs]</a>
</span><span id="line-1328">    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
</span><span id="line-1329"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1330"><span class="sd">        Set one or more parameters for every cell in the Assembly.</span>
</span><span id="line-1331">
</span><span id="line-1332"><span class="sd">        Values passed to set() may be:</span>
</span><span id="line-1333"><span class="sd">            (1) single values</span>
</span><span id="line-1334"><span class="sd">            (2) RandomDistribution objects</span>
</span><span id="line-1335"><span class="sd">            (3) mapping functions, where a mapping function accepts a single</span>
</span><span id="line-1336"><span class="sd">                argument (the cell index) and returns a single value.</span>
</span><span id="line-1337">
</span><span id="line-1338"><span class="sd">        Here, a &quot;single value&quot; may be either a single number or a list/array of</span>
</span><span id="line-1339"><span class="sd">        numbers (e.g. for spike times).</span>
</span><span id="line-1340"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1341">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1342">            <span class="n">p</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span></div>

</span><span id="line-1343">
</span><span id="line-1344">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;set(parametername=rand_distr)&quot;</span><span class="p">)</span>
</span><span id="line-1345">    <span class="k">def</span> <span class="nf">rset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parametername</span><span class="p">,</span> <span class="n">rand_distr</span><span class="p">):</span>
</span><span id="line-1346">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">parametername</span><span class="o">=</span><span class="n">rand_distr</span><span class="p">)</span>
</span><span id="line-1347">
<div class="viewcode-block" id="Assembly.record">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.record">[docs]</a>
</span><span id="line-1348">    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampling_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1349"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1350"><span class="sd">        Record the specified variable or variables for all cells in the Assembly.</span>
</span><span id="line-1351">
</span><span id="line-1352"><span class="sd">        `variables` may be either a single variable name or a list of variable</span>
</span><span id="line-1353"><span class="sd">        names. For a given celltype class, `celltype.recordable` contains a list of</span>
</span><span id="line-1354"><span class="sd">        variables that can be recorded for that celltype.</span>
</span><span id="line-1355">
</span><span id="line-1356"><span class="sd">        If specified, `to_file` should be either a filename or a Neo IO instance and `write_data()`</span>
</span><span id="line-1357"><span class="sd">        will be automatically called when `end()` is called.</span>
</span><span id="line-1358"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1359">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1360">            <span class="n">p</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">to_file</span><span class="p">,</span> <span class="n">sampling_interval</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="n">locations</span><span class="p">)</span></div>

</span><span id="line-1361">
</span><span id="line-1362">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;record(&#39;v&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-1363">    <span class="k">def</span> <span class="nf">record_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1364"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record the membrane potential from all cells in the Assembly.&quot;&quot;&quot;</span>
</span><span id="line-1365">        <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">to_file</span><span class="p">)</span>
</span><span id="line-1366">
</span><span id="line-1367">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;record([&#39;gsyn_exc&#39;, &#39;gsyn_inh&#39;])&quot;</span><span class="p">)</span>
</span><span id="line-1368">    <span class="k">def</span> <span class="nf">record_gsyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1369"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record synaptic conductances from all cells in the Assembly.&quot;&quot;&quot;</span>
</span><span id="line-1370">        <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">([</span><span class="s1">&#39;gsyn_exc&#39;</span><span class="p">,</span> <span class="s1">&#39;gsyn_inh&#39;</span><span class="p">],</span> <span class="n">to_file</span><span class="p">)</span>
</span><span id="line-1371">
<div class="viewcode-block" id="Assembly.get_population">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.get_population">[docs]</a>
</span><span id="line-1372">    <span class="k">def</span> <span class="nf">get_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="line-1373"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1374"><span class="sd">        Return the Population/PopulationView from within the Assembly that has</span>
</span><span id="line-1375"><span class="sd">        the given label. If no such Population exists, raise KeyError.</span>
</span><span id="line-1376"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1377">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1378">            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
</span><span id="line-1379">                <span class="k">return</span> <span class="n">p</span>
</span><span id="line-1380">        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Assembly does not contain a population with the label </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span></div>

</span><span id="line-1381">
<div class="viewcode-block" id="Assembly.save_positions">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.save_positions">[docs]</a>
</span><span id="line-1382">    <span class="k">def</span> <span class="nf">save_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
</span><span id="line-1383"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1384"><span class="sd">        Save positions to file. The output format is id x y z</span>
</span><span id="line-1385"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1386">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-1387">            <span class="n">file</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">StandardTextFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span><span id="line-1388">        <span class="n">cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cells</span>
</span><span id="line-1389">        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="line-1390">        <span class="n">result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">id_to_index</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">])</span>
</span><span id="line-1391">        <span class="n">result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span>
</span><span id="line-1392">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-1393">            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;assembly&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">})</span>
</span><span id="line-1394">            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

</span><span id="line-1395">
</span><span id="line-1396">    <span class="nd">@property</span>
</span><span id="line-1397">    <span class="k">def</span> <span class="nf">position_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1398">        <span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="line-1399">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="line-1400">        <span class="k">return</span> <span class="n">gen</span>
</span><span id="line-1401">
<div class="viewcode-block" id="Assembly.get_data">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.get_data">[docs]</a>
</span><span id="line-1402">    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1403"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1404"><span class="sd">        Return a Neo `Block` containing the data (spikes, state variables)</span>
</span><span id="line-1405"><span class="sd">        recorded from the Assembly.</span>
</span><span id="line-1406">
</span><span id="line-1407"><span class="sd">        `variables` - either a single variable name or a list of variable names</span>
</span><span id="line-1408"><span class="sd">                      Variables must have been previously recorded, otherwise an</span>
</span><span id="line-1409"><span class="sd">                      Exception will be raised.</span>
</span><span id="line-1410">
</span><span id="line-1411"><span class="sd">        For parallel simulators, if `gather` is True, all data will be gathered</span>
</span><span id="line-1412"><span class="sd">        to all nodes and the Neo `Block` will contain data from all nodes.</span>
</span><span id="line-1413"><span class="sd">        Otherwise, the Neo `Block` will contain only data from the cells</span>
</span><span id="line-1414"><span class="sd">        simulated on the local node.</span>
</span><span id="line-1415">
</span><span id="line-1416"><span class="sd">        If `clear` is True, recorded data will be deleted from the `Assembly`.</span>
</span><span id="line-1417"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1418">        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
</span><span id="line-1419">        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span><span id="line-1420">        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="n">clear</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">]</span>
</span><span id="line-1421">        <span class="c1"># adjust channel_ids to match assembly channel indices</span>
</span><span id="line-1422">        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-1423">        <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">):</span>
</span><span id="line-1424">            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
</span><span id="line-1425">                <span class="k">for</span> <span class="n">signal_array</span> <span class="ow">in</span> <span class="n">segment</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">:</span>
</span><span id="line-1426">                    <span class="n">signal_array</span><span class="o">.</span><span class="n">array_annotations</span><span class="p">[</span><span class="s2">&quot;channel_index&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="line-1427">            <span class="n">offset</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span>
</span><span id="line-1428">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
</span><span id="line-1429">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-1430">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">):</span>
</span><span id="line-1431">                <span class="n">segment</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1432">                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">segment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-1433">                <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">segment</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">:</span>
</span><span id="line-1434">                    <span class="n">arr</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="line-1435">                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-1436">        <span class="n">merged_block</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1437">        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1438">            <span class="n">merged_block</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span id="line-1439">        <span class="n">merged_block</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="line-1440">        <span class="n">merged_block</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
</span><span id="line-1441">        <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
</span><span id="line-1442">            <span class="n">merged_block</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="o">**</span><span class="n">annotations</span><span class="p">)</span>
</span><span id="line-1443">        <span class="k">return</span> <span class="n">merged_block</span></div>

</span><span id="line-1444">
</span><span id="line-1445">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;get_data(&#39;spikes&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-1446">    <span class="k">def</span> <span class="nf">getSpikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1447">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-1448">
</span><span id="line-1449">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;get_data(&#39;v&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-1450">    <span class="k">def</span> <span class="nf">get_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1451">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-1452">
</span><span id="line-1453">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;get_data([&#39;gsyn_exc&#39;, &#39;gsyn_inh&#39;])&quot;</span><span class="p">)</span>
</span><span id="line-1454">    <span class="k">def</span> <span class="nf">get_gsyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1455">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;gsyn_exc&#39;</span><span class="p">,</span> <span class="s1">&#39;gsyn_inh&#39;</span><span class="p">],</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-1456">
<div class="viewcode-block" id="Assembly.mean_spike_count">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.mean_spike_count">[docs]</a>
</span><span id="line-1457">    <span class="k">def</span> <span class="nf">mean_spike_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1458"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1459"><span class="sd">        Returns the mean number of spikes per neuron.</span>
</span><span id="line-1460"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1461">        <span class="n">spike_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spike_counts</span><span class="p">()</span>
</span><span id="line-1462">        <span class="n">total_spikes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">spike_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="line-1463">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">gather</span><span class="p">:</span>
</span><span id="line-1464">            <span class="c1"># should maybe use allgather, and get the numbers on all nodes</span>
</span><span id="line-1465">            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_spikes</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_counts</span><span class="p">)</span>
</span><span id="line-1466">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1467">            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

</span><span id="line-1468">
<div class="viewcode-block" id="Assembly.get_spike_counts">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.get_spike_counts">[docs]</a>
</span><span id="line-1469">    <span class="k">def</span> <span class="nf">get_spike_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1470"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1471"><span class="sd">        Returns the number of spikes for each neuron.</span>
</span><span id="line-1472"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1473">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-1474">            <span class="n">spike_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">count</span><span class="p">(</span>
</span><span id="line-1475">                <span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_record_filter</span><span class="p">)</span>
</span><span id="line-1476">        <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">NothingToWriteError</span><span class="p">:</span>
</span><span id="line-1477">            <span class="n">spike_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-1478">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="line-1479">            <span class="k">try</span><span class="p">:</span>
</span><span id="line-1480">                <span class="n">spike_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">_record_filter</span><span class="p">))</span>
</span><span id="line-1481">            <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">NothingToWriteError</span><span class="p">:</span>
</span><span id="line-1482">                <span class="k">pass</span>
</span><span id="line-1483">        <span class="k">return</span> <span class="n">spike_counts</span></div>

</span><span id="line-1484">
<div class="viewcode-block" id="Assembly.write_data">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.write_data">[docs]</a>
</span><span id="line-1485">    <span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1486"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1487"><span class="sd">        Write recorded data to file, using one of the file formats supported by</span>
</span><span id="line-1488"><span class="sd">        Neo.</span>
</span><span id="line-1489">
</span><span id="line-1490"><span class="sd">        `io`:</span>
</span><span id="line-1491"><span class="sd">            a Neo IO instance</span>
</span><span id="line-1492"><span class="sd">        `variables`:</span>
</span><span id="line-1493"><span class="sd">            either a single variable name or a list of variable names.</span>
</span><span id="line-1494"><span class="sd">            Variables must have been previously recorded, otherwise an</span>
</span><span id="line-1495"><span class="sd">            Exception will be raised.</span>
</span><span id="line-1496">
</span><span id="line-1497"><span class="sd">        For parallel simulators, if `gather` is True, all data will be gathered</span>
</span><span id="line-1498"><span class="sd">        to the master node and a single output file created there. Otherwise, a</span>
</span><span id="line-1499"><span class="sd">        file will be written on each node, containing only data from the cells</span>
</span><span id="line-1500"><span class="sd">        simulated on that node.</span>
</span><span id="line-1501">
</span><span id="line-1502"><span class="sd">        If `clear` is True, recorded data will be deleted from the `Population`.</span>
</span><span id="line-1503"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1504">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-1505">            <span class="n">io</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">get_io</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span><span id="line-1506">        <span class="k">if</span> <span class="n">gather</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-1507">            <span class="n">io</span><span class="o">.</span><span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span>
</span><span id="line-1508">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Recorder is writing &#39;</span><span class="si">%s</span><span class="s2">&#39; to file &#39;</span><span class="si">%s</span><span class="s2">&#39; with gather=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="line-1509">            <span class="n">variables</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">gather</span><span class="p">))</span>
</span><span id="line-1510">        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="n">clear</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
</span><span id="line-1511">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">gather</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="line-1512">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing data to file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">io</span><span class="p">)</span>
</span><span id="line-1513">            <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

</span><span id="line-1514">
</span><span id="line-1515">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;write_data(file, &#39;spikes&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-1516">    <span class="k">def</span> <span class="nf">printSpikes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1517">        <span class="bp">self</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;spikes&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-1518">
</span><span id="line-1519">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;write_data(file, &#39;v&#39;)&quot;</span><span class="p">)</span>
</span><span id="line-1520">    <span class="k">def</span> <span class="nf">print_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1521">        <span class="bp">self</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-1522">
</span><span id="line-1523">    <span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;write_data([&#39;gsyn_exc&#39;, &#39;gsyn_inh&#39;])&quot;</span><span class="p">)</span>
</span><span id="line-1524">    <span class="k">def</span> <span class="nf">print_gsyn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gather</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compatible_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1525">        <span class="bp">self</span><span class="o">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;gsyn_exc&#39;</span><span class="p">,</span> <span class="s1">&#39;gsyn_inh&#39;</span><span class="p">],</span> <span class="n">gather</span><span class="p">)</span>
</span><span id="line-1526">
<div class="viewcode-block" id="Assembly.inject">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.inject">[docs]</a>
</span><span id="line-1527">    <span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_source</span><span class="p">):</span>
</span><span id="line-1528"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1529"><span class="sd">        Connect a current source to all cells in the Assembly.</span>
</span><span id="line-1530"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1531">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1532">            <span class="n">current_source</span><span class="o">.</span><span class="n">inject_into</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

</span><span id="line-1533">
</span><span id="line-1534">    <span class="nd">@property</span>
</span><span id="line-1535">    <span class="k">def</span> <span class="nf">injectable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1536">        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">injectable</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">)</span>
</span><span id="line-1537">
<div class="viewcode-block" id="Assembly.describe">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.describe">[docs]</a>
</span><span id="line-1538">    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;assembly_default.txt&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
</span><span id="line-1539"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1540"><span class="sd">        Returns a human-readable description of the assembly.</span>
</span><span id="line-1541">
</span><span id="line-1542"><span class="sd">        The output may be customized by specifying a different template</span>
</span><span id="line-1543"><span class="sd">        togther with an associated template engine (see ``pyNN.descriptions``).</span>
</span><span id="line-1544">
</span><span id="line-1545"><span class="sd">        If template is None, then a dictionary containing the template context</span>
</span><span id="line-1546"><span class="sd">        will be returned.</span>
</span><span id="line-1547"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1548">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
</span><span id="line-1549">                   <span class="s2">&quot;populations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">]}</span>
</span><span id="line-1550">        <span class="k">return</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

</span><span id="line-1551">
<div class="viewcode-block" id="Assembly.get_annotations">
<a class="viewcode-back" href="../../../reference/populations.html#pyNN.neuron.Assembly.get_annotations">[docs]</a>
</span><span id="line-1552">    <span class="k">def</span> <span class="nf">get_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation_keys</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-1553"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1554"><span class="sd">        Get the values of the given annotations for each population in the Assembly.</span>
</span><span id="line-1555"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-1556">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-1557">            <span class="n">annotation_keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">annotation_keys</span><span class="p">,)</span>
</span><span id="line-1558">        <span class="n">annotations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="line-1559">
</span><span id="line-1560">        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">annotation_keys</span><span class="p">:</span>
</span><span id="line-1561">            <span class="n">is_array_annotation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-1562">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">populations</span><span class="p">:</span>
</span><span id="line-1563">                <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="line-1564">                <span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</span><span id="line-1565">                <span class="n">is_array_annotation</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="line-1566">            <span class="k">if</span> <span class="n">is_array_annotation</span><span class="p">:</span>
</span><span id="line-1567">                <span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="line-1568">            <span class="k">if</span> <span class="n">simplify</span><span class="p">:</span>
</span><span id="line-1569">                <span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">simplify_parameter_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</span><span id="line-1570">        <span class="k">return</span> <span class="n">annotations</span></div>

</span></code></pre></div>
    </div></div>
        </main>
      </div>
    </div><footer class="py-6 border-t border-border md:py-0">
    <div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
      <div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
        <p class="text-sm leading-loose text-center text-muted-foreground md:text-left">Â© 2006-2024, the PyNN community&nbsp;Built with <a class="font-medium underline underline-offset-4"
    href="https://www.sphinx-doc.org"
    rel="noreferrer">Sphinx 8.2.3</a></p>
</div>
</div>
</footer>
  </div>
  
    <script src="../../../_static/documentation_options.js?v=56343b9b"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script defer="defer" src="../../../_static/theme.js?v=073f68d9"></script>
  
</body>
</html>